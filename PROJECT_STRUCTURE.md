# Структура проекта

## Основные модули (Python)

### `main.py`
**Назначение:** Точка входа в приложение
- Инициализация всех компонентов
- Запуск бота и scheduler
- Обработка graceful shutdown
- Валидация конфигурации

### `bot.py`
**Назначение:** Основная логика Telegram бота
- Обработка команд пользователя (`/start`, `/add`, `/remove`, и т.д.)
- Работа с inline кнопками (callback queries)
- Отправка саммари пользователям
- Взаимодействие с базой данных и другими модулями

**Ключевые функции:**
- `cmd_start()` - приветствие и инструкции
- `cmd_add_channel()` - добавление канала
- `cmd_remove_channel()` - удаление канала
- `cmd_list_channels()` - список каналов
- `cmd_set_period()` - настройка периода
- `cmd_manual_summary()` - ручная генерация саммари
- `send_scheduled_summaries()` - автоматическая отправка

### `client.py`
**Назначение:** Работа с Telegram API через Telethon
- Авторизация пользовательского аккаунта
- Чтение сообщений из каналов (публичных и приватных)
- Проверка доступа к каналам
- Получение информации о каналах

**Ключевые функции:**
- `start()` - запуск Telegram клиента
- `get_channel_info()` - получение ID и названия канала
- `read_channel_messages()` - чтение сообщений за период
- `check_channel_access()` - проверка доступа

### `database.py`
**Назначение:** Работа с SQLite базой данных
- Хранение пользователей и их настроек
- Хранение списков отслеживаемых каналов
- Управление периодами отправки саммари
- Отслеживание времени последней отправки

**Таблицы:**
- `users` - пользователи бота и их настройки
- `channels` - отслеживаемые каналы

**Ключевые функции:**
- `init_db()` - создание таблиц
- `add_user()` - добавление пользователя
- `add_channel()` - добавление канала в отслеживание
- `get_user_channels()` - получение списка каналов пользователя
- `set_summary_period()` - установка периода
- `get_users_for_summary()` - получение пользователей для отправки

### `summarizer.py`
**Назначение:** Генерация саммари через OpenRouter API
- Форматирование сообщений для LLM
- Отправка запросов в OpenRouter
- Обработка ответов от LLM
- Создание единого саммари для нескольких каналов

**Ключевые функции:**
- `generate_summary()` - создание саммари одного канала
- `generate_multi_channel_summary()` - саммари нескольких каналов
- `_format_messages()` - форматирование сообщений

### `scheduler.py`
**Назначение:** Планирование автоматической отправки саммари
- Запуск периодических задач
- Проверка необходимости отправки каждый час
- Интеграция с APScheduler

**Ключевые функции:**
- `start()` - запуск планировщика
- `stop()` - остановка планировщика

### `config.py`
**Назначение:** Управление конфигурацией
- Загрузка переменных окружения из `.env`
- Валидация обязательных параметров
- Предоставление конфигурации другим модулям

## Утилиты и скрипты

### `setup.sh`
**Bash скрипт для первоначальной настройки:**
- Проверка установки Python
- Создание виртуального окружения
- Установка зависимостей
- Вывод инструкций по дальнейшей настройке

**Использование:**
```bash
./setup.sh
```

### `run.sh`
**Bash скрипт для запуска бота:**
- Проверка наличия `.env` файла
- Активация виртуального окружения
- Запуск `main.py`

**Использование:**
```bash
./run.sh
```

### `check_config.py`
**Python скрипт для проверки конфигурации:**
- Проверка наличия `.env` файла
- Валидация всех обязательных параметров
- Вывод статуса каждого параметра

**Использование:**
```bash
python check_config.py
```

## Конфигурация

### `.env.example`
Пример файла конфигурации с комментариями. Содержит:
- BOT_TOKEN
- API_ID и API_HASH
- OPENROUTER_API_KEY
- OPENROUTER_MODEL
- DATABASE_PATH
- SESSION_NAME

**Использование:**
```bash
cp .env.example .env
nano .env  # заполнить значения
```

### `.env` (создается пользователем)
Реальный файл конфигурации с секретными данными.
**⚠️ НЕ КОММИТИТЬ В GIT!**

### `.gitignore`
Список файлов и директорий, которые не должны попадать в git:
- Виртуальное окружение (`venv/`)
- Файл конфигурации (`.env`)
- База данных (`*.db`)
- Telegram сессии (`*.session`)
- Python кеш (`__pycache__/`)

### `requirements.txt`
Список Python зависимостей:
- `python-telegram-bot` - для бота
- `telethon` - для чтения каналов
- `requests` - для HTTP запросов
- `python-dotenv` - для `.env` файлов
- `APScheduler` - для периодических задач
- `aiosqlite` - для асинхронной работы с SQLite

### `telegram-summary-bot.service`
Systemd service файл для запуска бота как системного сервиса.

**Использование:**
```bash
sudo cp telegram-summary-bot.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable telegram-summary-bot
sudo systemctl start telegram-summary-bot
```

## Документация

### `README.md`
Полная документация проекта:
- Описание возможностей
- Требования
- Подробная инструкция по установке
- Все команды бота
- Работа с приватными каналами
- Запуск в фоне
- Устранение неполадок

### `QUICKSTART.md`
Краткая инструкция для быстрого старта:
- Минимальные шаги для запуска
- Получение всех необходимых токенов
- Первый запуск и авторизация
- Базовые команды

### `EXAMPLES.md`
Практические примеры использования:
- Разные сценарии использования
- Примеры команд
- Примеры вывода саммари
- Советы и рекомендации

### `PROJECT_STRUCTURE.md` (этот файл)
Описание структуры проекта и назначения каждого файла.

## Файлы, создаваемые при работе

### `bot_data.db`
SQLite база данных (создается автоматически):
- Таблица `users`
- Таблица `channels`

### `telegram_session.session`
Файл сессии Telethon (создается при первой авторизации):
- Хранит информацию об авторизованном аккаунте
- Позволяет не запрашивать код при каждом запуске

**⚠️ Важно:** Этот файл содержит доступ к вашему Telegram аккаунту!

## Архитектура

```
┌─────────────┐
│   main.py   │  ← Точка входа
└──────┬──────┘
       │
       ├──────────────────────────────────┐
       │                                  │
       ▼                                  ▼
┌─────────────┐                   ┌──────────────┐
│   bot.py    │◄──────────────────┤ scheduler.py │
└──────┬──────┘                   └──────────────┘
       │
       ├────────────┬────────────┬─────────────┐
       ▼            ▼            ▼             ▼
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────┐
│client.py │  │database  │  │summarizer│  │config  │
│(Telethon)│  │  .py     │  │   .py    │  │  .py   │
└──────────┘  └──────────┘  └──────────┘  └────────┘
       │            │            │             │
       ▼            ▼            ▼             ▼
   Telegram      SQLite     OpenRouter       .env
     API          DB           API
```

## Поток данных

1. **Пользователь** → команда → **bot.py**
2. **bot.py** → проверка доступа → **client.py** → Telegram API
3. **bot.py** → сохранение → **database.py** → SQLite
4. **scheduler.py** → проверка времени → **bot.py**
5. **bot.py** → чтение сообщений → **client.py** → Telegram API
6. **bot.py** → генерация саммари → **summarizer.py** → OpenRouter API
7. **bot.py** → отправка саммари → Пользователь

## Зависимости модулей

- `main.py` → `bot.py`, `scheduler.py`, `config.py`
- `bot.py` → `database.py`, `client.py`, `summarizer.py`, `config.py`
- `client.py` → `config.py`
- `summarizer.py` → `config.py`
- `scheduler.py` → (передается экземпляр bot)
- `database.py` → `config.py`
- `config.py` → `.env`

## Рекомендации по разработке

### Добавление новой команды
1. Добавьте обработчик в `bot.py`
2. Зарегистрируйте в `build_application()`
3. Добавьте описание в `/help`
4. Обновите `README.md`

### Добавление нового поля в БД
1. Измените схему в `database.py:init_db()`
2. Добавьте методы для работы с полем
3. Обновите код использования в `bot.py`

### Изменение формата саммари
1. Измените промпт в `summarizer.py:generate_summary()`
2. При необходимости измените форматирование в `_format_messages()`

### Изменение периодичности проверки
1. Измените CronTrigger в `scheduler.py:start()`
